name: Publish to dev.to

on:
  push:
    branches:
      - publish
    paths:
      - 'posts/**'

permissions:
  contents: write

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed posts
        id: changed
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD | grep '^posts/.*\.md$' || true)
          else
            FILES=$(git show --name-only --pretty="" HEAD | grep '^posts/.*\.md$' || true)
          fi
          echo "FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install devto-cli
        run: npm install -g devto-cli

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Process include syntax in posts
        if: steps.changed.outputs.FILES != ''
        env:
          FILES: ${{ steps.changed.outputs.FILES }}
        run: |
          python - <<'PY'
import os, sys, re, shlex
files = shlex.split(os.environ.get('FILES','').strip())
if not files:
    sys.exit(0)
for md in files:
    if not os.path.exists(md):
        print('Skip missing:', md)
        continue
    with open(md, 'r', encoding='utf-8') as f:
        s = f.read()

    pattern = re.compile(r':\(\s*([^\s\)]+)(?:\s+lang=([^\)\s]+))?\s*\)')

    def repl(m):
        rel = m.group(1)
        lang = m.group(2)
        base = os.path.dirname(md)
        p = rel if os.path.isabs(rel) else os.path.normpath(os.path.join(base, rel))
        if not os.path.exists(p):
            print('Included file not found:', p)
            return m.group(0)
        ext = os.path.splitext(p)[1].lower()
        if not lang:
            lang_map = {'.ps1':'powershell','.sh':'bash','.js':'javascript','.ts':'typescript',
                  '.py':'python','.json':'json','.html':'html','.css':'css'}
            lang = lang_map.get(ext, 'text')
        with open(p,'r',encoding='utf-8') as inc:
            code = inc.read().rstrip()
        return f"```{lang}\n{code}\n```"

    new = pattern.sub(repl, s)
    if new != s:
        with open(md, 'w', encoding='utf-8') as f:
            f.write(new)
        print('Processed includes in', md)
PY

      - name: Publish articles to dev.to
        if: steps.changed.outputs.FILES != ''
        env:
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          FILES: ${{ steps.changed.outputs.FILES }}
        run: |
          process_file() {
            local file="$1"
            local id=$(grep -E '^id:' "$file" | sed 's/id: *//')
            if [ -n "$id" ]; then
              echo "Updating article $id"
              npx devto-cli update "$file"
            else
              echo "Creating new article"
              local result=$(npx devto-cli create "$file")
              local new_id=$(echo "$result" | grep -oP 'id: \K\d+')
              if [ -n "$new_id" ]; then
                echo "Adding id $new_id to $file"
                sed -i "1a id: $new_id" "$file"
                git add "$file"
                git commit -m "Add id to $file"
                git push
              fi
            fi
          }
          for file in $FILES; do
            process_file "$file"
          done
