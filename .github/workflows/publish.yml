name: Publish to dev.to

on:
  push:
    branches:
      - publish
    paths:
      - 'posts/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed posts
        id: changed
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD | grep '^posts/.*\.md$' || true)
          else
            FILES=$(git show --name-only --pretty="" HEAD | grep '^posts/.*\.md$' || true)
          fi
          echo "FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Process include syntax in posts
        if: steps.changed.outputs.FILES != ''
        env:
          FILES: ${{ steps.changed.outputs.FILES }}
        run: |
          python - <<'PY'
          import os, sys, re
          files = [line.strip() for line in os.environ.get('FILES','').splitlines() if line.strip()]
          if not files:
              sys.exit(0)
          for md in files:
              if not os.path.exists(md):
                  print('Skip missing:', md)
                  continue
              with open(md, 'r', encoding='utf-8') as f:
                  s = f.read()

              pattern = re.compile(r':\(\s*([^\s\)]+)(?:\s+lang=([^\)\s]+))?\s*\)')

              def repl(m):
                  rel = m.group(1)
                  lang = m.group(2)
                  base = os.path.dirname(md)
                  p = rel if os.path.isabs(rel) else os.path.normpath(os.path.join(base, rel))
                  if not os.path.exists(p):
                      print('Included file not found:', p)
                      return m.group(0)
                  ext = os.path.splitext(p)[1].lower()
                  if not lang:
                      lang_map = {'.ps1':'powershell','.sh':'bash','.js':'javascript','.ts':'typescript',
                            '.py':'python','.json':'json','.html':'html','.css':'css'}
                      lang = lang_map.get(ext, 'text')
                  with open(p,'r',encoding='utf-8') as inc:
                      code = inc.read().rstrip()
                  return f"```{lang}\n{code}\n```"

              new = pattern.sub(repl, s)
              if new != s:
                  with open(md, 'w', encoding='utf-8') as f:
                      f.write(new)
                  print('Processed includes in', md)
          PY

      - name: Publish to dev.to
        if: steps.changed.outputs.FILES != ''
        uses: sinedied/publish-devto@v2
        with:
          devto_key: ${{ secrets.DEVTO_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          files: ${{ steps.changed.outputs.FILES }}
          branch: publish

        - name: Get published article URLs
        id: get_urls
        if: steps.changed.outputs.FILES != ''
        env:
          FILES: ${{ steps.changed.outputs.FILES }}
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          USERNAME: jankoweb
        run: |
          urls=$(python - <<'PY'
          import os, re, json, sys
          from urllib import request, parse

          files = [line.strip() for line in os.environ.get('FILES','').splitlines() if line.strip()]
          if not files:
            print('')
            sys.exit(0)

          headers = {'api-key': os.environ['DEVTO_API_KEY']}
          username = os.environ.get('USERNAME','jankoweb')
          url = f'https://dev.to/api/articles?username={parse.quote(username)}'
          req = request.Request(url, headers=headers)
          try:
            resp = request.urlopen(req, timeout=15)
            data = json.load(resp)
          except Exception as e:
            print('')
            sys.exit(0)

          out = []
          for md in files:
            title = None
            try:
              with open(md, 'r', encoding='utf-8') as f:
                s = f.read()
            except Exception:
              out.append(f'{md} -> ')
              continue
            m = re.match(r'---\n(.*?)\n---\n', s, re.S)
            if m:
              fm = m.group(1)
              tmatch = re.search(r'^title:\s*["\']?(.*?)["\']?$', fm, re.M)
              if tmatch:
                title = tmatch.group(1).strip()
            if not title:
              out.append(f'{md} -> ')
              continue
            found = None
            for a in data:
              if a.get('title','').strip() == title:
                found = a
                break
            if not found:
              out.append(f'{md} -> ')
            else:
              user = found.get('user',{}).get('username', username)
              slug = found.get('slug')
              article_url = f'https://dev.to/{user}/{slug}'
              out.append(f'{md} -> {article_url}')
          print('\n'.join(out))
          PY
          echo "ARTICLE_URLS<<EOF" >> $GITHUB_OUTPUT
          echo "$urls" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
